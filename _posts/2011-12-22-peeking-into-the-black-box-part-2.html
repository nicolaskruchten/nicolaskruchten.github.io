---
layout: redirect
title: Peeking Into the Black Box, Part 2 - Algorithm Meets World
image: http://nicolas.kruchten.com/content/wp-content/uploads/2011/12/Prezi006.jpg
dest: http://datacratic.com/site/blog/peeking-black-box-part-2-algorithm-meets-world
tags:
    - Real-Time Bidding
    - Datacratic
---

 <p><em>In </em><em><a href="http://datacratic.com/site/blog/peeking-black-box-part-1-datacratic%E2%80%99s-rtb-algorithms">Part 1</a> of <a href="http://datacratic.com/site/blog/tags/peeking">this series</a></em><em>, I claimed that <a href="http://datacratic.com/" target="_blank">Datacratic</a>’s RTB algorithm is able to take advantage of other bidders’ sub-optimal behaviour and navigate around publisher price floor in order to achieve advertiser goals. I then described the algorithm, which applies what can be called a “bid truthfully, pace economically” approach. In this second part, I show how this algorithm can in fact live up to these claims.</em></p>
<p>When you bid truthfully and pace economically, you are always trying to allocate your budget to the auctions which look like the best deals, whether that means that the user is very likely to click, or that the price is low because fewer bidders are in the running or there is no publisher price floor.</p>

<!-- more -->

<h3><big>How to Take Advantage of Other Bidders’ Behaviour</big></h3>
<p>In <a href="http://www.recoset.com/content/2011/09/rtb-pacing-is-everyone-doing-it-wrong/" target="_blank" title="RTB Pacing: is everyone doing it wrong?">Part 0 of this series</a>, I showed that the average win-price for <a href="http://www.recoset.com/content/2011/09/real-time-bidding-characterized/" target="_blank" title="Real Time Bidding, Characterized">RTB</a> auctions jumps up at midnight Eastern Time and described a pacing system which, if used by everyone, would prevent this jump, by spending at a constant rate. This system works by frequently updating a control value which is interpetted as the probability of bidding on any given auction. There is an implicit assumption underlying this system though: that any two randomly-selected bids are equivalent, regardless of, for example, the time of day. So while I introduced this system by talking about variability in the clearing price over the hours of the day, the simple pacer actually ignores this fact. <span class="arrow-call-out">This did not escape all readers of my post, some of whom commented in private that if we know the price is much higher at certain times, then we just shouldn’t bid at those times! </span>Now that I’ve described the way we compute expected surplus on a bid by bid basis, I can explain a principled way for a pacer to simultaneously handle variability in clearing prices and impression quality that doesn’t involve hardcoding hours when not to bid. All that is needed is for the pacing system to update the control value much less frequently, say once a day, and to treat the control value as a “minimum acceptable expected surplus” threshold. Consider the following graph comparing the evolution of average clearing-price and average expected surplus over a few days, noting how at midnight the price jumps and the surplus drops:</p>

<p><img src="http://nicolas.kruchten.com/content/wp-content/uploads/2011/12/winprice_vs_surplus.png" title="Clearing Price vs Surplus" /><br />The evolution of clearing price and surplus over time.</p>

<p>A well-tuned, infrequently-updating pacing system will essentially draw a horizontal line across this graph, and our bidder will bid whenever the surplus is higher than this threshold. The key insight here is that the curves here represent the means of some fairly wide and skewed distributions. Even if the mean price goes up and therefore the expected surplus drops, that doesn’t mean there aren’t any “good deals” to be had: it just means there are fewer of them. By setting a hard, slowly-changing threshold, our bidder can continue bidding throughout the day, but it will probably spend less in the hour right after midnight than in the hour right before midnight. <span class="quote">We like to say that this is taking advantage of other bidders’ sub-optimal behaviour because some bidders are irrationally piling into the market right after midnight and driving the price up.</span> Our algorithm continues to “skim the cream”, bidding in the best-looking auctions, but does back off a bit, holding its budget in reserve for such times as other bidders have run out of money for the day. As that happens, the drop in demand causes a drop in clearing price and a concurrent rise in expected surplus, causing our bidder to spend more.</p>
<h3>Navigating Around Publisher Price Floors</h3>
<p>Having covered how our algorithm responds to the actions of other bidders, how about publishers? How does this system respond to publisher <a href="http://en.wikipedia.org/wiki/Price_floor" target="_blank">price floors</a>? A price floor, or reserve price, is basically a statement by a publisher that they will not sell below a certain price. It’s almost as if a publisher is bidding on its own inventory. If there are no higher bids than the price floor, there is no transaction. If there is more than one bid above the price floor then the price floor does nothing and the winner pays the second price. If there is only one higher bid, however, that bidder wins and pays the reserve price. In this third case, the publisher gets some of the surplus from the auction that the winner would have gotten had there been no floor.</p>
<table><tbody><tr><th>First Price</th>
<th>Second Price</th>
<th>Reserve Price</th>
<th>Clearing Price</th>
</tr><tr><td style="text-align: center;">5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">(n/a)</td>
<td style="text-align: center;">3</td>
</tr><tr><td style="text-align: center;">5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
</tr><tr><td style="text-align: center;">5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
</tr><tr><td style="text-align: center;">5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">(no transaction)</td>
</tr></tbody></table><p>This all makes perfect sense at the micro level, as by definition if we win the auction, we were willing to pay more than we did: our bid was how much it was worth to us, and we paid the second price so the difference between the two is profit for us. Any publisher would rather that we had just paid them the entire bid amount so they could get that profit, and therefore they have an incentive to raise the price floor all the way to our bid amount to “capture back” as much of that surplus as they can. Our algorithm responds to a publisher price floor the same way it responds to the actions of other bidders causing the price to rise. At any given time, the pacer’s control value tells our bidder the minimum expected surplus required for it to bid. If a publisher raises their price floor (and if our price model captures this), the expected surplus of auctions for their impressions will drop. If it drops below the control value, we will simply not bid on those auctions at all, rather than accepting the higher price. This is what we call navigating around publisher price floors. The control value is set so that the budget will be met, and is based on the availability of surplus on the whole exchange, not just on any one publisher’s sites. In effect, this puts an upper bound on the price floor any publisher can set before losing our business, so long as we can get a higher expected surplus elsewhere. This upper bound will be lower than the value to us of winning the auction, but could still be higher than the next-highest bid, so we do give up some of the surplus to the publisher. This is pretty much the way the exchange should work: it’s a market mechanism which uses competition to divide up the surplus pie.</p>

<p><img src="http://nicolas.kruchten.com/content/wp-content/uploads/2011/12/price-floor.png" title="Price Floors" /><br />The control value places an upper bound on the price floor that is lower than the value.</p>

<p>It’s worth mentioning that at the macro level, publishers don’t necessarily sell all their inventory on a spot basis on the RTB exchange: they try to sell inventory at a much higher price on a <a href="http://en.wikipedia.org/wiki/Forward_contract" target="_blank">forward contract</a> basis ahead of time. In industry jargon, inventory sold on a forward contract basis is called “premium” and everything else is called “remnant”. Without getting too deeply into this, publishers have an incentive to put up very high floor prices so that advertisers don’t stop buying expensive premium inventory because they think they can buy the same impressions more cheaply on the spot market (i.e. as remnant inventory). The industry lingo for this effect is “cross-channel conflict”, because the remnant "channel" is perceived to be hurting the premium "channel". If a publisher is using this type of rationale to set a price floor, they will likely set it higher than the amount of our bid, rather than trying to squeeze it in between the first and second highest bids. This would translate into an expected surplus of zero, as there would be no chance of us winning the auction. Again, our algorithm just doesn’t bid on this type of auction; it certainly doesn’t raise the bid value to win an unprofitable impression. <a href="http://www.mikeonads.com/2010/09/25/price-floors-second-price-auctions-and-market-dynamics/" target="_blank">Mike on Ads has a good post</a> about why it’s a bad idea for publishers to do this, based on some hypothetical behaviour of bidders. Our algorithm can automatically implement the types of behaviour he describes.</p>
<p>This <a href="http://datacratic.com/site/blog/tags/peeking">Peeking Into the Black Box series</a> continues with <a href="http://datacratic.com/site/blog/peeking-black-box-part-3-beyond-surplus">Part 3: Beyond Surplus</a>!</p>