---
layout: redirect
title: Peeking Into the Black Box, Part 4 - Shady Bidding
dest: http://datacratic.com/site/blog/peeking-black-box-part-4-shady-bidding
tags:
    - Real-Time Bidding
    - Datacratic
---

<p>In <a href="http://datacratic.com/site/blog/peeking-black-box-part-1-datacratic%E2%80%99s-rtb-algorithms">Part 1</a> of <a href="http://datacratic.com/site/blog/tags/peeking">this series</a>, I said that in real-time bidding, we should “bid truthfully”, i.e. that you should bid whatever it is worth to you to win. To compute this truthful value, given a target cost per action (CPA) for a campaign, I said you could just multiply that target by the computed probability of seeing an action after the impression, and that would give you your bid value. </p>

<p>I added that by calculating an expected cost of winning an auction, you could compute the expected surplus for that auction and that to pace your spending efficiently, you would only bid truthfully when this expected surplus was above some threshold value, and not bid otherwise. This threshold value would be the output of a closed-loop pace control system (described in <a href="http://datacratic.com/site/blog/rtb-pacing-everyone-doing-it-wrong">Part 0</a>) whose job it is to keep the spend rate close to some target.</p>

<p>In <a href="http://datacratic.com/site/blog/peeking-black-box-part-3-beyond-surplus">Part 3</a> of this series, I then showed that in fact, the second claim of Part 1 was not optimal and that instead of setting an expected surplus threshold, you should set an expected return-on-investment (ROI) threshold. </p>

<p>In this post, Part 4 of the series, I show that the meaning of “bidding truthfully” can be slipperier than expected, and that you can get the same results as an ROI-based pacing strategy with a perfect expected-cost model, without even needing to use an expected-cost model.</p>

<!-- more -->

<h3>Same Same but Different</h3>

<p>Let’s say you’ve implemented the ROI-based strategy described in <a href="http://datacratic.com/site/blog/peeking-black-box-part-3-beyond-surplus">Part 3</a>. You have an opportunity to bid on an impression which you compute has a 0.1% chance of resulting in an action such as a click or conversion. The target CPA is $1 so you’re willing to bid 1000 microdollars. Your pacing system tells you that right now, the minimum expected ROI you should accept is 50%. Do you bid or not? The answer depends on how much you think the impression will cost: if you think it will cost less than 666 micros, then yes, because any more than that and the expected ROI will be less than 50%.</p>

<p>Now say that you estimate that the cost of winning this auction will be 500 micros (pre-auction expected ROI of 100%) so you bid the 1000 micros and… too bad, your cost estimate was off by 50% and you paid 750 micros. Your post-auction expected ROI is now 33%, which is less than you were willing to accept before the auction. Bummer.</p>

<p>But wait, given that you were willing to bid 1000 micros if the cost was less than 666 micros and nothing otherwise, then you don’t actually need to estimate the cost and run the risk of being wrong: you could just bid 666 micros. The cost is determined by the next-highest bid: if it’s lower than 666 then you win and you pay less than 666 for something which was worth 1000 to you (ROI is greater than 50%, as desired!), and if it’s higher then you lose and you pay nothing (ROI not well defined). Essentially, the auction mechanism is computing the cost for you and always coming up with the right answer. </p>

<p>Let’s switch to symbols: under the scheme described in Part 3 (let’s call it the <em>“truth-or-nothing” bidding policy</em>), you’re willing to bid your expected value V when the expected ROI is X or higher and 0 otherwise. If C is the expected cost (and assuming that C &lt; V otherwise we wouldn’t be bidding, so the P(win) is 1), then the expected ROI is (V-C)/C and the ROI is X or higher when the cost is at or lower than V/(X+1). </p>

<p><img src="http://nicolas.kruchten.com/images/peeking/4-1.png" /></p>

<p>Given the mechanics of second-price auctions, if you happen to have a great cost estimator and are willing to bid some amount B when the cost C is less than or equal to D then, assuming B&gt;D, you should be always be willing to bid D: you will win and lose the exact same auctions at exactly the same cost. We can call the policy of bidding at D when you were willing to bid at B the <em>“shaded” bidding policy</em>, because <a href="http://en.wikipedia.org/wiki/Bid_shading">bid-shading</a> is the technical term for bidding lower than you’re willing to pay. So the following bidding policies are equivalent:</p>
<p><img src="http://nicolas.kruchten.com/images/peeking/4-2.png" /></p>

<p>Here’s a rough proof for all costs: </p>
<p>
<table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><thead><tr><th scope="col">Cost</th>
<th scope="col">Truth-or-Nothing Bid</th>
<th scope="col">Shaded Bid</th>
<th scope="col">Truth-or-Nothing Win?</th>
<th scope="col">Shaded Win?</th>
</tr></thead><tbody><tr><td style="text-align: center;">C &gt; B</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">D</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">no</td>
</tr><tr><td style="text-align: center;">B&gt;C&gt;D</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">D</td>
<td style="text-align: center;">no</td>
<td style="text-align: center;">no</td>
</tr><tr><td style="text-align: center;">C&lt;D</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">D</td>
<td style="text-align: center;">yes</td>
<td style="text-align: center;">yes</td>
</tr></tbody></table></p>

<p>Putting it all together, given that X is always greater than 0 (we don’t accept a negative ROI), the following bidding policies are equivalent:</p>
<p><img src="http://nicolas.kruchten.com/images/peeking/4-3.png" /></p>

<p>The big surprise here is that the shaded bid policy gives you the same results as the truth-or-nothing policy and <em>you don’t actually need to compute an expected cost at all</em>. In fact, you get the same outcomes bidding with the shaded policy as you do with the truth-or-nothing policy <em>if you have a perfect cost model</em>. If you have a less-than-perfect cost model, the truth-or-nothing policy could perform much worse. Given that no one has a perfect cost model and that building even a mediocre one is a lot of work, the shaded policy is clearly a pretty big improvement!</p>

<p>How should we reconcile this with the theory that bidding truthfully is the surplus-optimal thing to do in a single auction? The proof of this optimally boils down to the fact that for a given single auction, if you bid higher than your true value, you might overpay (i.e. get a negative surplus) and if you bid lower, you might lose out on an opportunity to get what you want at a lower cost than its value (i.e. get a positive surplus). In a context like RTB, though, where you spread out your spend over millions of auctions, it’s OK to miss an opportunity to get a bit of positive surplus, if there’s a higher-ROI opportunity coming up, so shading your bids is not a bad idea. There’s another problem with bidding truthfully, though, which comes up if you don’t actually know the true value of winning.</p>

<h3>The Lower the Better</h3>

<p>The problem I laid out in <a href="http://datacratic.com/site/blog/peeking-black-box-part-1-datacratic%E2%80%99s-rtb-algorithms">Part 1</a> of this series was one in which you had a set budget to spend over a given time period and you were trying to get actions that were worth a certain known amount. In direct-response campaigns, sometimes there is a concrete, known target CPA, but in something like a branding campaign, it can be a little fuzzier: the target CPA is not actually the value that the advertiser ascribes to getting an action, it comes out of comparisons with other channels/campaigns (on an ROI basis). In an arbitrage or variable-margin context, the "target" CPA is a maximum allowable CPA: no one will complain if the CPA is lower than the target. So in fact, you often just want the lowest CPA you can get, and the hard constraint is to spend the media budget or achieve the delivery objective. In a case like this, it’s actually very difficult to bid “truthfully”.</p>

<p>Conveniently, though, the result above yields a very simple approach to this type of situation. The shaded policy described above calls for bidding V/(X+1) where V is the target CPA * P(action) and X is the minimum expected ROI you’re willing to accept, according to a closed-loop pace controller, as described in <a href="http://datacratic.com/site/blog/rtb-pacing-everyone-doing-it-wrong">Part 0</a>. The pace controller doesn’t really know or care about ROI, though, it just outputs a control value that correlates well with spend rate, so that it can keep the pace on track. That means that we can rearrange the equations a little bit to say that for every auction: </p>
<p><img src="http://nicolas.kruchten.com/images/peeking/4-4.png" /></p>

<p>and take the output of the pace controller to be K instead of X.</p>

<p>Bidding in this way spends the budget while minimizes the CPA, given the constraints of liquidity and the availability of a good P(action) predictor. Given its lack of reference to ROI, value or cost, it even works when the “budget” is not dollars to be spent but impressions or actions to be bought (i.e. an arbitrage situation rather than a branding campaign). The only consideration if there is a known target CPA is to ensure that the system is able to push the CPA below the target; if it isn’t, then there is not enough liquidity to make the campaign work under the given constraints.</p>

<h3>Conclusion</h3>
<p>This post is Part 4 of a so far <a href="http://datacratic.com/site/blog/tags/peeking">five-part series</a> (the first post being grandfathered in as “Part 0”) in which I’ve described the evolution of Datacratic’s real-time bidding algorithm over time. We started with a closed-loop control system, which has been a constant feature of our system over the years, and we’ve used it to modulate our bidding behaviour according to an ever-more sophisticated economic understanding of how to succeed in an RTB environment. The latest iteration of our algorithm is deceptively simple but by this point, theoretically quite well-grounded. Throughout this series, I haven’t put a lot of emphasis on how we actually compute the probability that an impressions being bought will result in some user action like a click or conversion but clearly, this is where the biggest value-add of our system lies, and we will be describing the internals of that part of our system on this blog in the near future.</p>